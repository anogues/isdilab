
USE ROLE ACCOUNTADMIN;
CREATE DATABASE IF NOT EXISTS LAB_DB; -- si no usamos terraform

CREATE SCHEMA IF NOT EXISTS LAB_DB.BRONZE; -- si no usamos terraform

USE DATABASE LAB_DB;

USE SCHEMA BRONZE;

CREATE STAGE IF NOT EXISTS LAB_DB.BRONZE.INTERNAL_CUSTOMER_STAGE; -- si no usamos terraform

CREATE ROLE IF NOT EXISTS TRANSFORMER;

GRANT ROLE TRANSFORMER TO ROLE SYSADMIN;

CREATE WAREHOUSE IF NOT EXISTS DBT_LAB_WH WAREHOUSE_SIZE = 'XSMALL' AUTO_SUSPEND = 60 AUTO_RESUME = TRUE INITIALLY_SUSPENDED = TRUE;

GRANT USAGE ON WAREHOUSE DBT_LAB_WH TO ROLE TRANSFORMER;

GRANT USAGE ON DATABASE LAB_DB TO ROLE TRANSFORMER;

GRANT USAGE ON SCHEMA LAB_DB.bronze TO ROLE TRANSFORMER; -- A schema 'bronze'

GRANT READ ON STAGE LAB_DB.bronze.INTERNAL_CUSTOMER_STAGE TO ROLE TRANSFORMER;

GRANT CREATE SCHEMA ON DATABASE LAB_DB TO ROLE TRANSFORMER; -- Para crear schemas de destino

GRANT CREATE EXTERNAL TABLE ON SCHEMA LAB_DB.bronze TO ROLE TRANSFORMER;

CREATE USER IF NOT EXISTS DBT_USER PASSWORD = 'xxxxx' LOGIN_NAME = 'DBT_USER' DEFAULT_WAREHOUSE = 'DBT_LAB_WH' DEFAULT_ROLE = 'TRANSFORMER' MUST_CHANGE_PASSWORD = FALSE;

GRANT ROLE TRANSFORMER TO USER DBT_USER;

GRANT CREATE TABLE ON FUTURE SCHEMAS IN DATABASE LAB_DB TO ROLE TRANSFORMER;

GRANT CREATE VIEW ON FUTURE SCHEMAS IN DATABASE LAB_DB TO ROLE TRANSFORMER;


USE DATABASE LAB_DB;
USE SCHEMA bronze; -- O el schema donde quieras guardar el formato de archivo

CREATE OR REPLACE FILE FORMAT my_csv_format
  TYPE = CSV
  FIELD_DELIMITER = ','
  SKIP_HEADER = 1
  EMPTY_FIELD_AS_NULL = TRUE
  -- Añade más opciones si es necesario
  COMMENT = 'Formato CSV estándar para el lab';

-- Otorgar permiso de uso al rol de dbt
GRANT USAGE ON FILE FORMAT LAB_DB.bronze.my_csv_format TO ROLE TRANSFORMER;
